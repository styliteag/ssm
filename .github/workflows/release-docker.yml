name: Release Docker Build

on:
  push:
    branches: 
      - 'release-*'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Extract version from VERSION file
      id: version
      run: |
        VERSION=$(cat VERSION | tr -d '\n')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"
        
        # Extract major and minor versions for additional tags
        IFS='.' read -r -a version_parts <<< "$VERSION"
        MAJOR="${version_parts[0]}"
        MINOR="${version_parts[1]}"
        echo "major=$MAJOR" >> $GITHUB_OUTPUT
        echo "minor=$MINOR" >> $GITHUB_OUTPUT
        echo "Major: $MAJOR, Minor: $MINOR"
        
    - name: Extract branch name
      id: branch
      run: |
        BRANCH_NAME=${GITHUB_REF#refs/heads/}
        echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
        echo "Branch: $BRANCH_NAME"
        
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
        
    - name: Build and push release Docker images
      uses: docker/build-push-action@v6
      with:
        push: true
        context: .
        file: docker/app/Dockerfile
        cache-from: type=gha
        cache-to: type=gha,mode=max
        tags: |
          styliteag/ssh-key-manager:${{ steps.version.outputs.version }}
          styliteag/ssh-key-manager:release-${{ steps.version.outputs.major }}.${{ steps.version.outputs.minor }}
          styliteag/ssh-key-manager:release-${{ steps.version.outputs.major }}
          styliteag/ssh-key-manager:release-latest
          ghcr.io/${{ github.repository }}/ssh-key-manager:${{ steps.version.outputs.version }}
          ghcr.io/${{ github.repository }}/ssh-key-manager:release-${{ steps.version.outputs.major }}.${{ steps.version.outputs.minor }}
          ghcr.io/${{ github.repository }}/ssh-key-manager:release-${{ steps.version.outputs.major }}
          ghcr.io/${{ github.repository }}/ssh-key-manager:release-latest
          
    - name: Create GitHub release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ steps.version.outputs.version }}
        release_name: Release v${{ steps.version.outputs.version }}
        body: |
          Release v${{ steps.version.outputs.version }}
          
          Built from branch: ${{ steps.branch.outputs.branch }}
          
          Docker Images:
          - `styliteag/ssh-key-manager:${{ steps.version.outputs.version }}`
          - `ghcr.io/${{ github.repository }}/ssh-key-manager:${{ steps.version.outputs.version }}`
        draft: false
        prerelease: false